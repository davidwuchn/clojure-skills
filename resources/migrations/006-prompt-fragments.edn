{:id "006-prompt-fragments"
 :up
 ["CREATE TABLE IF NOT EXISTS prompt_fragments (
     id INTEGER PRIMARY KEY AUTOINCREMENT,
     name TEXT NOT NULL UNIQUE,
     title TEXT,
     description TEXT,
     created_at TEXT NOT NULL DEFAULT (datetime('now')),
     updated_at TEXT NOT NULL DEFAULT (datetime('now'))
   )"

  "CREATE INDEX IF NOT EXISTS idx_prompt_fragments_name ON prompt_fragments(name)"

  "CREATE TABLE IF NOT EXISTS prompt_fragment_skills (
     fragment_id INTEGER NOT NULL,
     skill_id INTEGER NOT NULL,
     position INTEGER NOT NULL,
     created_at TEXT NOT NULL DEFAULT (datetime('now')),
     PRIMARY KEY (fragment_id, skill_id),
     FOREIGN KEY (fragment_id) REFERENCES prompt_fragments(id) ON DELETE CASCADE,
     FOREIGN KEY (skill_id) REFERENCES skills(id) ON DELETE CASCADE
   )"

  "CREATE INDEX IF NOT EXISTS idx_prompt_fragment_skills_fragment ON prompt_fragment_skills(fragment_id)"
  "CREATE INDEX IF NOT EXISTS idx_prompt_fragment_skills_skill ON prompt_fragment_skills(skill_id)"

  "ALTER TABLE prompts ADD COLUMN fragment_refs TEXT"

  "CREATE TABLE IF NOT EXISTS prompt_references (
     id INTEGER PRIMARY KEY AUTOINCREMENT,
     source_prompt_id INTEGER NOT NULL,
     target_prompt_id INTEGER,
     target_fragment_id INTEGER,
     reference_type TEXT NOT NULL CHECK(reference_type IN ('prompt', 'fragment')),
     position INTEGER NOT NULL,
     created_at TEXT NOT NULL DEFAULT (datetime('now')),
     FOREIGN KEY (source_prompt_id) REFERENCES prompts(id) ON DELETE CASCADE,
     FOREIGN KEY (target_prompt_id) REFERENCES prompts(id) ON DELETE CASCADE,
     FOREIGN KEY (target_fragment_id) REFERENCES prompt_fragments(id) ON DELETE CASCADE,
     CONSTRAINT chk_target_reference CHECK (
       (target_prompt_id IS NOT NULL AND target_fragment_id IS NULL) OR
       (target_prompt_id IS NULL AND target_fragment_id IS NOT NULL)
     )
   )"

  "CREATE INDEX IF NOT EXISTS idx_prompt_references_source ON prompt_references(source_prompt_id)"
  "CREATE INDEX IF NOT EXISTS idx_prompt_references_target_prompt ON prompt_references(target_prompt_id)"
  "CREATE INDEX IF NOT EXISTS idx_prompt_references_target_fragment ON prompt_references(target_fragment_id)"
  "CREATE INDEX IF NOT EXISTS idx_prompt_references_type ON prompt_references(reference_type)"]

 :down
 ["DROP INDEX IF EXISTS idx_prompt_references_type"
  "DROP INDEX IF EXISTS idx_prompt_references_target_fragment"
  "DROP INDEX IF EXISTS idx_prompt_references_target_prompt"
  "DROP INDEX IF EXISTS idx_prompt_references_source"
  "DROP TABLE IF EXISTS prompt_references"
  "ALTER TABLE prompts DROP COLUMN fragment_refs"
  "DROP INDEX IF EXISTS idx_prompt_fragment_skills_skill"
  "DROP INDEX IF EXISTS idx_prompt_fragment_skills_fragment"
  "DROP TABLE IF EXISTS prompt_fragment_skills"
  "DROP INDEX IF EXISTS idx_prompt_fragments_name"
  "DROP TABLE IF EXISTS prompt_fragments"]}